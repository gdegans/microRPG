<!DOCTYPE html>
<html>
	<head>
		<title>Micro RPG</title>
		<style>

		td /* Toutes les cellules des tableaux... */
		{
			border: 1px solid black; /* auront une bordure de 1px */
			width: 60px;
			height: 60px;
			text-align: center;
		}

		#zone1 {
			width: 300px;
			height: 400px;
			border: 1px solid black;
		}

		#zonePersonnage {
			background-color: lightgrey;
		}

		#zoneXP {
			background-color: lightgreen;
			width: 0px;
			height: 5px;
		}

		#zoneEnnemi {
			background-color: lightgrey;
		}

		#zoneMap {
			position: absolute;
			top: 4px;
			left: 320px;
		}

		</style>
	</head>

	<body>
		<div id="zone1">
			<div id="zoneXP">
			</div>
			<div id="zonePersonnage">
			</div>
			<br/>
			<div id="zoneEnnemi">
			</div>
			<br/>
			<div id="zoneMessage">
			</div>
		</div>
		<div id="zoneMap">
		</div>

		<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script>
			let socket = io.connect('http://localhost:8080'); // Connexion Socket.io

			let pseudo = prompt("Bonjour, jeune héros. Comment devons-nous t'appeler ?");
			let nbAttaque = 0;
			let taille = 0;

			function Vider(zone) {
				document.getElementById(zone).innerHTML = "";
			}

			function CompterAttaque() {
				nbAttaque++;
			}

			function ResetAttaque() {
				nbAttaque = 0;
			}

			function ResetEnCombat(joueur) {
				joueur.enCombat = 0;
			}

			function SetEnCombat(joueur) {
				joueur.enCombat = 1;
			}

			function ActualiserJoueur(joueur) {
				document.getElementById('zonePersonnage').innerHTML =
				'<u>Fiche de personnage :</u>' +
				'<br/><b>' + joueur.nom + '</b>' +
				'<br/>Niveau : ' + joueur.niveau +
				'<br/>PV : ' + joueur.pv +
				'<br/>Force : ' + joueur.force +
				'<br/>Défense : ' + joueur.defense +
				'<br/>XP à ce niveau : ' + joueur.xp + '<br/>';
				//attention aux failles XSS. Utiliser innerTEXT, $``
				//if ((nbAttaque == 0) && (joueur.enCombat == 0)) {
					//document.getElementById('zonePersonnage').innerHTML +=
					//'<br/><button type="button" onclick="socket.emit(\'creation_ennemi\', { joueurClient: joueur}); " id="bouton_combattre">Nouveau monstre !</button>';
				//}
				taille = (joueur.xp / joueur.palier) * 300;
				if (taille > 300) {
					taille = 300;
				}
				$("#zoneXP").css("width", taille + "px");
			}

			function ActualiserEnnemi(joueur, ennemi) {
				if (nbAttaque == 0) {
					document.getElementById('zoneEnnemi').innerHTML = 'Attention ! Un nouvel ennemi arrive.';
				}
				document.getElementById('zoneEnnemi').innerHTML = '<br/>';
				document.getElementById('zoneEnnemi').innerHTML +=
				'<br/>' + ennemi.nom + ' niveau ' + ennemi.niveau +
				'<br/>PV : ' + ennemi.pv +
				'<br/>Force : ' + ennemi.force +
				'<br/>Défense : ' + ennemi.defense;
				if (ennemi.pv > 0 && joueur.pv > 0) {
					document.getElementById('zoneEnnemi').innerHTML +=
					'<br/><button type="button" onclick="CompterAttaque(); socket.emit(\'attaque\', { joueurClient: joueur, ennemiClient: ennemi});" id="bouton_attaquer">Attaquer !</button>';
				}
			}

			function Recommencer(pseudo) {
				document.getElementById('zonePersonnage').innerHTML = "";
				document.getElementById('zoneEnnemi').innerHTML = "";
				document.getElementById('zoneMessage').innerHTML = "";
				ResetAttaque();
				socket.emit('creation_joueur', pseudo);
				socket.emit('creation_map');
			}

			socket.emit('creation_joueur', pseudo);
			socket.emit('creation_map');

			socket.on('envoi_joueur', function(data) {
				joueur = data.joueurServeur;
				ActualiserJoueur(joueur);
			});

			socket.on('envoi_map', function(data) {
				map = data.mapServeur;
				var affichageMap = "";
				var i = 1;
				var j = 1;
				affichageMap = "<table><tr>";
				while (j <= map.ymax) {
					affichageMap += "<tr>";
					while (i <= map.xmax) {
						if (map[i][j] === "Rat mutant") {
							affichageMap += "<td style='background-color: yellow'>" + map[i][j] + "</td>";
						} else if (map[i][j] === "Baston") {
							affichageMap += "<td style='background-color: red'>" + map[i][j] + "</td>";
						} else if (map[i][j] === "Joueur") {
							affichageMap += "<td style='background-color: green'>" + map[i][j] + "</td>";
						} else if (map[i][j] === "Mort") {
							affichageMap += "<td style='background-color: black; color: white'>" + map[i][j] + "</td>";
						} else {
							affichageMap += "<td>" + map[i][j] + "</td>";
						}
						//$("td").css("background-color", "white");
						i++;
					}
					affichageMap += "</tr>";
					i = 1;
					j++;
				}
				//affichageMap += "</tr>";
				//i = 1;
				//j++;
				affichageMap += "</table>";
				document.getElementById('zoneMap').innerHTML = affichageMap;
			});

			socket.on('nouvel_ennemi', function(data) {
				joueur = data.joueurServeur;
				ennemi = data.ennemiServeur;
				ActualiserEnnemi(joueur, ennemi);
				Vider('zoneMessage');
			});

			socket.on('actualiser', function(data) {
				joueur = data.joueurServeur;
				ennemi = data.ennemiServeur;
				ActualiserJoueur(joueur);
				ActualiserEnnemi(joueur, ennemi);
			});

			socket.on('mort_joueur', function(joueur) {
				document.getElementById('zoneMessage').innerHTML =
				'Quel dommage, ' + joueur.nom + '... Si près du but :(' +
				'<br/>Voulez-vous recommencer ?' +
				'<br/><button type="button" onclick="Recommencer(pseudo);" id="bouton_recommencer">Oui !</button>';
			});

			socket.on('mort_ennemi', function(data) {
				joueur = data.joueurServeur;
				ennemi = data.ennemiServeur;
				document.getElementById('zoneMessage').innerHTML =
				'Bravo, vous avez terrassé un ' + ennemi.nom + ' de niveau ' + ennemi.niveau + ' !' +
				'<br/>Vous remportez ' + ennemi.xp + ' XP !' +
				'<br/>Continuer à farmer des mobs ?' +
				'<br/><button type="button" onclick="ResetEnCombat(joueur); ResetAttaque(); ActualiserJoueur(joueur); Vider(\'zoneEnnemi\'); Vider(\'zoneMessage\'); socket.emit(\'actualiser\', { joueurClient: joueur, ennemiClient: ennemi}); socket.emit(\'actualiser_map\');" id="bouton_combattre">Continuer !</button>';
				//ActualiserJoueur(joueur);
			});

			document.addEventListener('keydown', (event) => {
				const nomTouche = event.key;
				if ((nomTouche === 'ArrowUp') || (nomTouche === 'ArrowRight') || (nomTouche === 'ArrowDown') || nomTouche === ('ArrowLeft')) {
					socket.emit('deplacement_joueur', nomTouche);
					//return;
				}
				if (nomTouche === "a") {
					document.getElementById('bouton_attaquer').click();
				}
				if (nomTouche === "c") {
					document.getElementById('bouton_combattre').click();
				}
				if (nomTouche === "o") {
					document.getElementById('bouton_recommencer').click();
				}
			}, false);

		</script>

	</body>
</html>
